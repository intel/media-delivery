From 6f882d671c2cdcb83501ef8626f86456e786ac1e Mon Sep 17 00:00:00 2001
From: Haihao Xiang <haihao.xiang@intel.com>
Date: Mon, 4 Jan 2021 10:45:48 +0800
Subject: [PATCH 11/17] qsv: add macro QSV_ONEVPL for the oneVPL SDK

---
 libavcodec/qsv.c          | 4 ++--
 libavcodec/qsv_internal.h | 3 ++-
 libavcodec/qsvenc.c       | 2 +-
 libavcodec/qsvenc.h       | 2 +-
 libavfilter/qsvvpp.c      | 2 +-
 libavfilter/qsvvpp.h      | 3 ++-
 libavutil/hwcontext_qsv.c | 3 ++-
 7 files changed, 11 insertions(+), 8 deletions(-)

diff --git a/libavcodec/qsv.c b/libavcodec/qsv.c
index bd05255..eb827a3 100644
--- a/libavcodec/qsv.c
+++ b/libavcodec/qsv.c
@@ -36,8 +36,8 @@
 #include "qsv_internal.h"
 
 #define MFX_IMPL_VIA_MASK(impl) (0x0f00 & (impl))
-#define QSV_HAVE_USER_PLUGIN    !QSV_VERSION_ATLEAST(2, 0)
-#define QSV_HAVE_AUDIO          !QSV_VERSION_ATLEAST(2, 0)
+#define QSV_HAVE_USER_PLUGIN    !QSV_ONEVPL
+#define QSV_HAVE_AUDIO          !QSV_ONEVPL
 
 #if QSV_VERSION_ATLEAST(1, 12)
 #include "mfxvp8.h"
diff --git a/libavcodec/qsv_internal.h b/libavcodec/qsv_internal.h
index cf7f688..0babf72 100644
--- a/libavcodec/qsv_internal.h
+++ b/libavcodec/qsv_internal.h
@@ -60,7 +60,8 @@
     ((MFX_VERSION.Major > (MAJOR)) ||                           \
     (MFX_VERSION.Major == (MAJOR) && MFX_VERSION.Minor >= (MINOR)))
 
-#define QSV_HAVE_OPAQUE  !QSV_VERSION_ATLEAST(2, 0)
+#define QSV_ONEVPL       QSV_VERSION_ATLEAST(2, 0)
+#define QSV_HAVE_OPAQUE  !QSV_ONEVPL
 
 typedef struct QSVMid {
     AVBufferRef *hw_frames_ref;
diff --git a/libavcodec/qsvenc.c b/libavcodec/qsvenc.c
index 53690c4..2f29ad6 100644
--- a/libavcodec/qsvenc.c
+++ b/libavcodec/qsvenc.c
@@ -100,7 +100,7 @@ static const struct {
 #if QSV_HAVE_VCM
     { MFX_RATECONTROL_VCM,     "VCM" },
 #endif
-#if QSV_VERSION_ATLEAST(1, 10) && !QSV_VERSION_ATLEAST(2, 0)
+#if QSV_VERSION_ATLEAST(1, 10) && !QSV_ONEVPL
     { MFX_RATECONTROL_LA_EXT,  "LA_EXT" },
 #endif
 #if QSV_HAVE_LA_HRD
diff --git a/libavcodec/qsvenc.h b/libavcodec/qsvenc.h
index 9cfbb3f..4d9f60b 100644
--- a/libavcodec/qsvenc.h
+++ b/libavcodec/qsvenc.h
@@ -64,7 +64,7 @@
 #define QSV_HAVE_ICQ    QSV_VERSION_ATLEAST(1, 28)
 #define QSV_HAVE_VCM    0
 #define QSV_HAVE_QVBR   QSV_VERSION_ATLEAST(1, 28)
-#define QSV_HAVE_MF     QSV_VERSION_ATLEAST(1, 25) && !QSV_VERSION_ATLEAST(2, 0)
+#define QSV_HAVE_MF     QSV_VERSION_ATLEAST(1, 25) && !QSV_ONEVPL
 #endif
 
 #if !QSV_HAVE_LA_DS
diff --git a/libavfilter/qsvvpp.c b/libavfilter/qsvvpp.c
index b0c58e1..1de7de5 100644
--- a/libavfilter/qsvvpp.c
+++ b/libavfilter/qsvvpp.c
@@ -39,7 +39,7 @@
 #endif
 #define IS_SYSTEM_MEMORY(mode) (mode & MFX_MEMTYPE_SYSTEM_MEMORY)
 #define MFX_IMPL_VIA_MASK(impl) (0x0f00 & (impl))
-#define QSV_HAVE_AUDIO          !QSV_VERSION_ATLEAST(2, 0)
+#define QSV_HAVE_AUDIO          !QSV_ONEVPL
 
 static const AVRational default_tb = { 1, 90000 };
 
diff --git a/libavfilter/qsvvpp.h b/libavfilter/qsvvpp.h
index e04115c..67c351f 100644
--- a/libavfilter/qsvvpp.h
+++ b/libavfilter/qsvvpp.h
@@ -40,7 +40,8 @@
     ((MFX_VERSION.Major > (MAJOR)) ||                           \
     (MFX_VERSION.Major == (MAJOR) && MFX_VERSION.Minor >= (MINOR)))
 
-#define QSV_HAVE_OPAQUE  !QSV_VERSION_ATLEAST(2, 0)
+#define QSV_ONEVPL       QSV_VERSION_ATLEAST(2, 0)
+#define QSV_HAVE_OPAQUE  !QSV_ONEVPL
 
 typedef struct QSVFrame {
     AVFrame          *frame;
diff --git a/libavutil/hwcontext_qsv.c b/libavutil/hwcontext_qsv.c
index ba11452..a20aa19 100644
--- a/libavutil/hwcontext_qsv.c
+++ b/libavutil/hwcontext_qsv.c
@@ -54,7 +54,8 @@
     (MFX_VERSION_MAJOR > (MAJOR) ||         \
      MFX_VERSION_MAJOR == (MAJOR) && MFX_VERSION_MINOR >= (MINOR))
 
-#define QSV_HAVE_OPAQUE  !QSV_VERSION_ATLEAST(2, 0)
+#define QSV_ONEVPL       QSV_VERSION_ATLEAST(2, 0)
+#define QSV_HAVE_OPAQUE  !QSV_ONEVPL
 
 typedef struct QSVDevicePriv {
     AVBufferRef *child_device_ctx;
-- 
1.8.3.1

